setup:
  - gateway: '3.4'
prereqs:
  blocks:
    - |
      echo '
      _format_version: "3.0"
      services:
        - name: example-service
          url: http://httpbin.konghq.com/anything
      routes:
        - name: example-route
          paths:
          - "/anything"
          service:
            name: example-service
      ' | deck gateway apply -
steps:
  - |
    echo '
    _format_version: "3.0"
    consumers:
      - username: jsmith
        jwt_secrets:
        - algorithm: HS256
          key: YJdmaDvVTJxtcWRCvkMikc8oELgAVNcz
          secret: C50k0bcahDhLNhLKSUBSR1OMiFGzNZ7X
    ' | deck gateway apply -
  - |
    echo '
    _format_version: "3.0"
    plugins:
      - name: jwt
        config:
          header_names:
          - authorization
          key_claim_name: iss
    ' | deck gateway apply -
  - name: env-variables
    config:
      JWT_TOKEN: >-
        eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJZSmRtYUR2VlRKeHRjV1JDdmtNaWtjOG9FTGdBVk5jeiJ9.xG-DrlD4vcYBqhuhK_jrwFIALvVvU-qTOiNyIfUhn_Y
  - name: unauthorized-check
    config:
      message: Unauthorized
      status_code: 401
      url: http://localhost:8000/anything
  - name: request-check
    config:
      headers:
        - 'Authorization: Bearer $JWT_TOKEN'
        - 'Content-Type: application/json'
      status_code: 200
      url: http://localhost:8000/anything
