setup:
  - konnect
prereqs:
  blocks:
    - |
      echo '
      _format_version: "3.0"
      services:
        - name: example-service
          url: http://httpbin.konghq.com/anything
      routes:
        - name: example-route
          paths:
          - "/anything"
          service:
            name: example-service
      ' | deck gateway apply -
steps:
  - |
    echo '
    _format_version: "3.0"
    consumers:
      - username: anonymous
      - username: Dana
      - username: Mahan
    ' | deck gateway apply -
  - |
    echo '
    _format_version: "3.0"
    plugins:
      - name: key-auth
        service: example-service
        config:
          hide_credentials: true
          anonymous: anonymous
      - name: basic-auth
        service: example-service
        config:
          hide_credentials: true
          anonymous: anonymous
    ' | deck gateway apply -
  - name: request-check
    config:
      status_code: 200
      display_headers: true
      url: $KONNECT_PROXY_URL/anything
  - name: request-check
    config:
      status_code: 200
      display_headers: true
      headers:
        - apikey:nonsense
      url: $KONNECT_PROXY_URL/anything
  - |
    echo '
    _format_version: "3.0"
    consumers:
      - username: Dana
        basicauth_credentials:
        - username: Dana
          password: dana
      - username: Mahan
        keyauth_credentials:
        - key: mahan
    ' | deck gateway apply -
  - |
    echo '
    _format_version: "3.0"
    consumers:
      - username: anonymous
        plugins:
        - name: request-termination
          config:
            status_code: 401
            message: '"Error - Authentication required"'
    ' | deck gateway apply -
  - name: request-check
    config:
      status_code: 401
      display_headers: true
      headers:
        - apikey:nonsense
      url: $KONNECT_PROXY_URL/anything
  - name: request-check
    config:
      status_code: 401
      display_headers: true
      url: $KONNECT_PROXY_URL/anything
  - name: request-check
    config:
      user: Dana:dana
      status_code: 200
      display_headers: true
      url: $KONNECT_PROXY_URL/anything
