setup:
  - konnect
prereqs:
  blocks:
    - |
      echo '
      _format_version: "3.0"
      services:
        - name: example-service
          url: http://httpbin.konghq.com/anything
      routes:
        - name: example-route
          paths:
          - "/anything"
          service:
            name: example-service
      ' | deck gateway apply -
steps:
  - |
    echo '
    _format_version: "3.0"
    consumers:
      - username: jsmith
        keyauth_credentials:
        - key: example-key
    ' | deck gateway apply -
  - |
    echo '
    _format_version: "3.0"
    plugins:
      - name: key-auth
        config:
          key_names:
          - apikey
    ' | deck gateway apply -
  - |
    echo '
    _format_version: "3.0"
    plugins:
      - name: rate-limiting
        consumer: jsmith
        config:
          minute: 5
          hour: 1000
    ' | deck gateway apply -
  - name: rate-limit-check
    config:
      message: API rate limit exceeded
      status_code: 429
      iterations: 6
      headers:
        - apikey:example-key
      url: $KONNECT_PROXY_URL/anything
