---
title: Secure traffic over an autogenerated MCP server using the AI MCP OAuth plugin
content_type: how_to
related_resources:
  - text: AI Gateway
    url: /ai-gateway/
  - text: AI MCP Proxy
    url: /plugins/ai-mcp-proxy/
  - text: AI MCP OAuth2
    url: /plugins/ai-mcp-oauth2/
  - text: MCP Traffic Gateway
    url: /mcp/

description: This tutorial demonstrates how to secure traffic for an autogenerated MCP server using the AI MCP OAuth2 plugin and expose it to clients like Cursor.

products:
  - gateway
  - ai-gateway

permalink: /mcp/secure-autogenerated-mcp-tools/

works_on:
  - on-prem
  - konnect

min_version:
  gateway: '3.12'

plugins:
  - ai-mcp-proxy
  - ai-mcp-oauth2

entities:
  - service
  - route
  - plugin

tags:
  - ai
  - openai
  - mcp

tldr:
  q: How do I secure an autogenerated MCP server for AI clients?
  a: |
    Use the AI MCP Proxy to expose API endpoints as MCP tools and protect them with the AI MCP OAuth2 plugin. This ensures only authorized clients can access the tools, while providing authentication via Keycloak.

tools:
  - deck

prereqs:
  inline:
    - title: Cursor
      content: |
        This tutorial uses Cursor as an MCP client:
        1. Go to the [Cursor downloads](https://cursor.com/downloads) page.
        2. Download the installer for your operating system.
        3. Install Cursor on your machine.
        4. Launch Cursor and sign in to your account or create a new account.
      icon_url: /assets/icons/cursor.svg
    - title: Keycloak
      include_content: prereqs/keycloak
      icon_url: /assets/icons/cursor.svg
  entities:
    services:
      - mcp-service
    routes:
      - mcp-route

automated_tests: false
---

## Install mock API Server

Before you can use the [AI MCP Proxy](/plugins/ai-mcp-proxy/) plugin, you’ll need an upstream HTTP API. In this tutorial, we’ll set up a lightweight mock API with Express. This lets you test locally without relying on an external service. The mock API simulates a simple marketplace: a fixed list of users, each with two to five sample orders, exposed via `/marketplace/users` and `/marketplace/{userId}/orders`.


Set up the mock API by running:

```sh
curl -s -o api.js "https://gist.githubusercontent.com/subnetmarco/5ddb23876f9ce7165df17f9216f75cce/raw/a44a947d69e6f597465050cc595b6abf4db2fbea/api.js"
npm install express
node api.js
```

Verify that the API is running:

```sh
curl -X GET http://localhost:3000
```

You should see:

```text
{"name":"Sample Users API"}%
```

{:.no-copy-code}

Later, the AI MCP Proxy will use this API’s OpenAPI schema to generate MCP tool definitions, while the AI MCP OAuth2 plugin will handle authentication.


## Configure the AI MCP Proxy plugin

With the mock API server running, configure the AI MCP Proxy plugin to expose its endpoints as MCP tools.
The following example maps the mock API operations to MCP tool definitions that the client can invoke.

{% entity_examples %}
entities:
  plugins:
    - name: ai-mcp-proxy
      route: mcp-route
      config:
        mode: conversion-listener
        tools:
        - description: Get users
          method: GET
          path: "/marketplace/users"
          parameters:
          - name: id
            in: query
            required: false
            schema:
              type: string
            description: Optional user ID
        - description: Get orders for a user
          method: GET
          path: "/marketplace/orders"
          parameters:
          - description: User ID to filter orders
            in: query
            name: userid
            required: true
            schema:
              type: string
        server:
          timeout: 60000
{% endentity_examples %}


## Configure AI MCP Oauth2 plugin

To secure access to the MCP server, attach the AI MCP OAuth2 plugin to the same route. This plugin validates incoming access tokens against Keycloak and injects claims as headers for downstream services.

{% entity_examples %}
entities:
  plugins:
    - name: ai-mcp-oauth2
      config:
        resource: ${mcp_auth_url}
        authorization_servers:
          - ${keycloak_authz_url}
        introspection_endpoint: ${keycloak_introspection_url}
        client_id: ${client_id}
        client_secret: ${client_secret}
        claim_to_header:
          - claim: "sub"
            header: "X-User-Id"
        insecure_relaxed_audience_validation: true

variables:
  mcp_auth_url:
    value: $MCP_AUTH_URL
    description: The MCP authentication resource endpoint.
  keycloak_authz_url:
    value: $KEYCLOAK_AUTHZ_URL
    description: The Keycloak authorization server URL.
  keycloak_introspection_url:
    value: $KEYCLOAK_INTROSPECTION_URL
    description: |
      The Keycloak token introspection endpoint.
      {{site.base_gateway}} uses this endpoint to verify access tokens sent by MCP client.
  client_id:
    value: $CLIENT_ID
    description: The client ID used by {{site.base_gateway}} in introspection.
  client_secret:
    value: $CLIENT_SECRET
    description: The client secret used by {{site.base_gateway}} in introspection.
{% endentity_examples %}


## Configure Cursor

1. Open your Cursor desktop app.

2. Navigate to **Cursor > Settings**.

3. In the **Settings** tab, go to **Tools & integrations** in the left sidebar.

4. In the **MCP Tools** section, click **Add Custom MCP**.

5. Paste the following JSON configuration into the newly opened `mcp.json` tab:

   ```json
   {
     "mcpServers": {
       "marketplace": {
         "url": "http://localhost:8000/marketplace"
       }
     }
   }
   ```

6. Return to the **Cursor settings** tab. You should now see the Marketplace MCP server with two tools available:

   ![Tools exposed in Cursor](/assets/images/ai-gateway/cursor-tools.png){: style="display:block; margin-left:auto; margin-right:auto; width:50%; border-radius:10px" }

7. To open a new Cursor chat, click <kbd>cmd</kbd> + <kbd>L</kbd> if you're on Mac, or <kbd>ctrl</kbd> + <kbd>L</kbd> if you're on Windows.

8. In the Cursor chat tab, click **@ Add Context** and select `mcp.json`:

![Add context in Cursor chat](/assets/images/ai-gateway/cursor-add-context.png){: style="display:block; margin-left:auto; margin-right:auto; width:50%; border-radius:10px" }

## Validate the configuration

TO BE ADDED