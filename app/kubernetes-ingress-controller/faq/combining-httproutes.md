---
title: Combining Services from different HTTPRoutes

description: |
  Reduce the number of Gateway Services generated by {{ site.kic_product_name }} when using HTTPRoutes

breadcrumbs:
  - /kubernetes-ingress-controller/
  - index: kubernetes-ingress-controller
    section: FAQs

content_type: reference
layout: reference

products:
  - kic

works_on:
  - on-prem
  - konnect
---

{{ site.kic_product_name }} can consolidate rules from multiple `HTTPRoute` resources that target the same backend services into a single {{ site.base_gateway }} service.

## Enable the feature

Use the `--combined-services-from-different-httproutes` CLI flag to enable this functionality, or enable via Helm: 

```yaml
ingressController:
  enabled: true
  installCRDs: true
  env:
    # this will inject CONTROLLER_COMBINED_SERVICES_FROM_DIFFERENT_HTTPROUTES="true"
    combined_services_from_different_httproutes: "true"
    
```

## How does Combined Services From Different HTTPRoutes work?

Any rules with same combination of backend services (combination of namespace, name, port, and weight in `backendRefs` of rules) in all `HTTPRoute`s within the same namespace are translated to one {{site.base_gateway}} Service.

## How is the translation done?

The names of the translated {{site.base_gateway}} Service are changed when the feature is enabled. Instead of generating names from source `HTTPRoute`
and rules, the {{site.base_gateway}} Service names are generated from the consolidated backends.

### Compute Service name

Names of {{site.base_gateway}} Services are computed from the namespace, name, port, and weight (if specified). The pattern of names is:

```
httproute.NAMESPACE.svc.BACKEND_NS.BACKEND_NAME.BACKEND_PORT.[BACKEND_WEIGHT]_[NEXT_BACKENDs]...
```

Where:
 - `namespace` is the namespace of the `HTTPRoute`s.
 - `backend_ns` is the namespace of the first backend service.
 - `backend_name` is the name of the first backend service.
 - `backend_port` is the port number of the first backend service.
 - `backend_weight` is the weight of the first backend service, if specified.
 - `next_backends` are sections computed from other backend services. Backend services are sorted by the namespace and name.

When the computed name is longer than 512 characters (the limit of Service name length in {{site.konnect_short_name}}), the backend service name is trimmed using the following rules:

- Only use `backend_ns`, `backend_name`,`backend_port`, `backend_weight`,
- Append the `_combined.<hash>` to make sure that the name is unique, where `hash` is the SHA256 digest of the computed service name.

For example, here are two `HTTPRoute`s with rules pointing to the same backends, with the same ports and weights:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httproute-consolidated-1
  namespace: default
spec:
  parentRefs:
  - name: kong
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /httproute-testing
    backendRefs:
    - name: echo-1
      kind: Service
      port: 80
      weight: 75
    - name: echo-2
      kind: Service
      port: 8080
      weight: 25
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httproute-consolidated-2
  namespace: default
spec:
  parentRefs:
  - name: kong
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /httproute-testing
    backendRefs:
    - name: echo-1
      kind: Service
      port: 80
      weight: 75
    - name: echo-2
      kind: Service
      port: 8080
      weight: 25
```

When the feature is disabled (which is the default), the rules in the two `HTTPRoutes` are translated to two distinct {{site.base_gateway}} Services:
`httproute.default.httproute-consolidated-1.0` and `httproute.default.httproute-consolidated-2.0`.

When the feature is enabled, the rules from the two `HTTPRoute`s, `httproute-consolidated-1` and `httproute-consolidated-2`, result in a single {{site.base_gateway}} Service named `httproute.default.svc.default.echo-1.80.75.default.echo-2.80.25`.
