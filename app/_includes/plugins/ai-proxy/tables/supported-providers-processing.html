{% assign note_counter = 0 %}
{% assign notes = "" | split: "" %}
{% assign features = "files,batches,assistants,responses,function_calling" | split: "," %}

{% comment %}First pass: collect all notes{% endcomment %}
{% for provider in include.providers %}
  {% for feature in features %}
    {% assign feature_data = provider[feature] %}
    {% if feature_data.note.content %}
      {% assign note_counter = note_counter | plus: 1 %}
      {% assign notes = notes | push: feature_data.note.content %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% comment %}Reset counter for second pass{% endcomment %}
{% assign current_note = 0 %}

<table>
  <thead>
    <tr>
      <th>Provider</th>
      <th>Files</th>
      <th>Batches</th>
      <th>Assistants</th>
      <th>Responses</th>
      <th>Function Calling</th>
    </tr>
  </thead>
  <tbody>
    {% for provider in include.providers %}
    <tr id="{{ provider.name }}">
      <td>
        {{ provider.name }}{% if provider.formats %} ({{ provider.formats }}){% endif %}
        {% for feature in features %}
          {% assign feature_data = provider[feature] %}
          {% if feature_data.supported == true and feature_data.min_version != '' and feature_data.min_version %}
            {% new_in {{ feature_data.min_version }} %}
            {% break %}
          {% endif %}
        {% endfor %}
      </td>
      {% for feature in features %}
        {% assign feature_data = provider[feature] %}
        <td>
          {% if feature_data.supported == 'n/a' %}
            n/a{% if feature_data.note.content %}<sup>{{ current_note | plus: 1 }}</sup>{% assign current_note = current_note | plus: 1 %}{% endif %}
          {% elsif feature_data.note.content %}
            {{ feature_data.supported | to_check }}<sup>{{ current_note | plus: 1 }}</sup>{% assign current_note = current_note | plus: 1 %}
          {% else %}
            {{ feature_data.supported | to_check }}
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

{% comment %}Render collected notes{% endcomment %}
{% if notes.size > 0 %}
{% for note in notes %}
<p><sup>{{ forloop.index }})</sup> {{ note }}</p>
{% endfor %}
{% endif %}