---
title: Keyring
content_type: reference
layout: reference

products:
    - gateway
breadcrumbs:
  - /gateway/
description: |
  A Keyring is a mechanism that encrypts sensitive data fields, such as consumer secrets, before storing them in the database.
  This provides for encryption-at-rest security controls in a {{site.base_gateway}} cluster.

related_resources:
  - text: Vault entity
    url: /gateway/entities/vault/
  - text: Certificate entity
    url: /gateway/entities/certificate/
  - text: Encrypt sensitive data in {{site.base_gateway}} with a Keyring
    url: /how-to/encrypt-sensitive-data-in-kong-gateway-with-keyring/
  - text: Store Keyring data in a HashiCorp Vault
    url: /how-to/store-keyring-in-hashicorp-vault/
tags:
  - security
  - encryption
api_specs:
  - gateway/admin-ee

tools:
  - admin-api

schema:
  api: gateway/admin-ee
  path: /schemas/Keyring

faqs:
  - q: What is the difference between a Vault and a Keyring?
    a: |
      A Keyring and a [Vault](/gateway/entities/vault/) are both used to secure secrets, but they use different approaches. The Keyring contains encryption keys used to encrypt sensitive data fields before they're written to the database. The same key is then used to decrypt the data when reading from the database. A Vault is a container that securely stores secrets. You can then reference these secrets in other {{site.base_gateway}} entities. 
      
      The Keyring is configured for the whole {{site.base_gateway}} instance and will automatically encrypt a [list of fields](#encrypted-fields) defined by {{site.base_gateway}}. In a Vault, each secret needs to be added and then referenced. However, a Vault supports storing some fields not supported by the Keyring.
      
      You may choose a Vault if you want to secure certain fields that are not encrypted by the Keyring. If all the fields you want to secure are encrypted, the Keyring may be a quicker solution to implement.
  - q: Where does {{site.base_gateway}} store the contents of the Keyring?
    a: "{{site.base_gateway}} stores Keyring material in a shared memory zone that all {{site.base_gateway}} worker processes access. To prevent keys from being written to disk as part of memory paging operations, we recommend disabling memory swapping on systems running {{site.base_gateway}}."
  - q: What happens to the keys if a {{site.base_gateway}} node fails?
    a: In cluster mode, the contents of the Keyring propagate automatically among all nodes in the {{site.base_gateway}} cluster. One node failing does not impact the Keyring. However, at least one node must be running at all times within the cluster; a failure of all nodes requires manually re-importing the Keyring to one node during an outage recovery.

works_on:
  - on-prem
---

## What is a Keyring?

A Keyring is a mechanism that encrypts sensitive data fields, such as consumer secrets, before storing them in the database. The Keyring stores keys used to encrypt and decrypt data.

This functionality provides transparent, symmetric encryption of sensitive data fields at rest. 
When enabled, encryption and decryption of data are done on-the-fly by {{site.base_gateway}} immediately before writing to the database and after reading from the database. 
Responses containing sensitive fields generated by the Admin API continue to show data as plain text. {{site.base_gateway}} runtime elements, such as plugins, can access sensitive fields transparently, without requiring additional configuration.

## How Keyring encryption works

The following sections describe how Keyring encryption works.

### Encrypted fields

The Keyring encrypts the following fields:

- The `key` fields in a [`certificate` object](/gateway/entities/certificate/), which is the private key for a TLS certificate.
- Certain configuration parameters in plugins and plugin-related authentication objects. These parameters have an `encrypted` label in the plugin's configuration reference.

### Encryption and decryption

{{site.base_gateway}} uses 256-bit AES encryption in Galois/Counter Mode (GCM mode). Cryptographic nonce values for each encryption routine execution are derived from the kernel CSPRNG (`/dev/urandom`). The AES routines used by {{site.base_gateway}} are provided by the OpenSSL library bundled with the {{site.base_gateway}} package.

## Key generation and lifecycle

Once you've enabled Keyring with the `cluster` strategy on all {{site.base_gateway}} nodes in your cluster, the encryption process will work like this:
1. You generate a key using the `/keyring/generate` Admin API endpoint. 
1. {{site.base_gateway}} stores this key and its ID in a shared memory zone in the data store, which is accessible to all nodes in your cluster.
1. You create a plugin that contains an encrypted field. For example, a plugin with an API key field.
1. Using the key you generated, {{site.base_gateway}} encrypts the value of the encrypted fields and writes the data to the {{site.base_gateway}} database.
1. If any {{site.base_gateway}} node in the cluster receives a request, through the `/plugins` API endpoint for example, it uses the key you generated to decrypt the sensitive fields and returns the data in plain text.

If you generate a new key:
- New data is encrypted using the new key
- Older keys remain in the Keyring to decrypt previously-encrypted data, but are no longer used for encryption

## Disaster recovery

To automatically back up your Keyring material, make sure to configure the `keyring_recovery_public_key` parameter to point to your `cert.pem` file. See [Enable Keyring](#enable-keyring) for more details.

The Keyring material is then encrypted with the public RSA key defined with the `keyring_recovery_public_key` value in the database. The corresponding private key can be used to decrypt the Keyring material in the database:
```sh
curl -X POST localhost:8001/keyring/recover -F recovery_private_key=@./key.pem
```

The response contains a list of keys that were successfully recovered and a list of keys that could not be recovered. The {{site.base_gateway}} error log will contain the detailed reason why the keys could not be recovered.

To allow {{site.base_gateway}} to use a recovered key, you need to activate it:

```sh
curl -X POST localhost:8001/keyring/activate -d key=$KEY_ID
```

## Enable Keyring

### 1. Generate an RSA key pair

Use the `openssl` CLI to generate an RSA key pair that can be used to export and recover Keyring material:
```sh
openssl genrsa -out key.pem 2048
openssl rsa -in key.pem -pubout -out cert.pem
```

### 2. Configure {{site.base_gateway}}
To enable data encryption, you must modify the {{site.base_gateway}} configuration. You can either update `kong.conf` or use environment variables:

{% navtabs "update-kong-configuration" %}
{% navtab "kong.conf" %}
Set the following values in `kong.conf`:
```sh
keyring_enabled = on
keyring_strategy = cluster
keyring_recovery_public_key = /path/to/generated/cert.pem
```
{% endnavtab %}
{% navtab "Environment variables" %}
Create the following environment variables:
```sh
export KONG_KEYRING_ENABLED=on
export KONG_KEYRING_STRATEGY=cluster
export KONG_KEYRING_RECOVERY_PUBLIC_KEY=./cert.pem
```
{% endnavtab %}
{% endnavtabs %}

### 3. Start {{site.base_gateway}} and generate a key
Once the configuration is updated, you can start your {{site.base_gateway}} instance and use the following request to make create a new key in the Keyring:

```sh
curl -X POST localhost:8001/keyring/generate
```

This key will then be used to encrypt sensitive fields in the database. 
To validate that it's working, you can create a plugin with data in an encrypted field, and then check the database to make sure the data is encrypted.
