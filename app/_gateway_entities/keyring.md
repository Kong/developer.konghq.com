---
title: Keyring
content_type: reference
entities:
  - keyring

description: |
  A Keyring is the mechanism for storing sensitive data fields, such as consumer secrets, in an encrypted format within the database. 
  This provides for encryption-at-rest security controls in a {{site.base_gateway}} cluster.

related_resources:
  - text: Key entity
    url: /gateway/entities/key/
  - text: Key-set entity
    url: /gateway/entities/key-set/

tier: enterprise

api_specs:
  - gateway/admin-ee

tools:
  - admin-api

schema:
  api: gateway/admin-ee
  path: /schemas/Keyring

faqs:
  - q: What is the difference between a Vault and a Keyring?
    a: |
      A Keyring and a Vault are both used to secure secrets, but they use different approaches. The Keyring contains encryption keys used to encrypt sensitive data fields before they're written to the database. The same key is then used to decrypt the data when reading from the database. A Vault is a container that securely stores secrets. You can then reference these secrets in other {{site.base_gateway}} entities. 
      
      The Keyring is configured for the whole {{site.base_gateway}} instance and will automatically encrypt any sensitive field. In a Vault, each secret needs to be added and then referenced.
---

## What is a Keyring?

A Keyring is a mechanism for storing sensitive data fields, such as consumer secrets, in an encrypted format within the database. 

This functionality provides transparent, symmetric encryption of sensitive data fields at rest. 
When enabled, encryption and decryption of data are done on-the-fly by Kong immediately before writing to the database and after reading from the database. 
Responses containing sensitive fields generated by the Admin API continue to show data as plain text. Kong runtime elements, such as plugins, can access sensitive fields transparently, without requiring additional configuration.

## Encryption details

### Encrypted fields

The Keyring encrypts the following fields:

- The `key` fields in a `certificate` object, which is the private key for a TLS certificate.
- Certain configuration parameters in plugins and plugin-related authentication objects. These parameters have an `encrypted` label in the plugin's configuration reference.

### Encryption and decryption

{{site.base_gateway}} uses 256-bit AES encryption in GCM mode. Cryptographic nonce values for each encryption routine execution are derived from the kernel CSPRNG (`/dev/urandom`). The AES routines used by Kong are provided by the OpenSSL library bundled with the {{site.base_gateway}}package.

## Key generation and lifecycle

{{site.base_gateway}}’s keyring handling mechanisms allow for more than one key to be present on any given Kong node at a time. Each key may be used to read encrypted fields from the database, but only one key at any given time is used to write encrypted fields back to the data store. This process allows for a key rotation mechanism wherein new keyring material is introduced, and older keys may be present for a time to allow rotating previously-encrypted fields.

Through the kernel CSPRNG, Kong derives keyring material generated through the `/keyring/generate` Admin API endpoint. Kong stores keyring material in a shared memory zone that all Kong worker processes access. To prevent key material from being written to disk as part of memory paging operations, we recommend that swap be disabled on systems running Kong.

When operating in cluster mode, keyring material propagates automatically among all nodes in the Kong cluster. Because Kong nodes don't have a notion of direct peer-to-peer communication, the underlying data store serves as a communication channel to transmit messages. When a Kong node starts, it generates an ephemeral RSA key pair. The node’s public keys propagate to all other active nodes in the cluster. When an active node sees a message request for keyring material, it wraps the in-memory keyring material in the presented public key, and transmits the payload back over the central messaging channel provided by the underlying data store. This process allows each node in the cluster to broadcast keyring material to new nodes, without sending key material in plaintext over the wire. This model requires that at least one node be running at all times within the cluster; a failure of all nodes requires manually re-importing the keyring to one node during an outage recovery.

## Disaster recovery

To automatically back up your Keyring material, make sure to configure the `keyring_recovery_public_key` parameter to point to your `cert.pem` file. See [Enable Keyring](#enable-keyring) for more details.

The Keyring material is then encrypted with the public RSA key defined with the `keyring_recovery_public_key` value in the database. The corresponding private key can be used to decrypt the keyring material in the database:
```sh
curl -X POST localhost:8001/keyring/recover -F recovery_private_key=@/path/to/generated/key.pem
```

The response contains a list of keys that were successfully recovered and that could not be recovered. The Kong error log will contain the detailed reason why the keys could not be recovered.

## Enable Keyring

### 1. Generate an RSA key pair

Use the `openssl` CLI to generate an RSA key pair that can be used to export and recover keyring material.
```sh
openssl genrsa -out key.pem 2048
openssl rsa -in key.pem -pubout -out cert.pem
```

### 2. Configure Kong
Enabling data encryption in Kong requires modifying the Kong configuration. You can either update `kong.conf` or use environment variables:

{% navtabs %}
{% navtab "kong.conf" %}
Set the following values in `kong.conf`:
```sh
keyring_enabled = on
keyring_strategy = cluster
keyring_recovery_public_key = /path/to/generated/cert.pem
```
{% endnavtab %}
{% navtab "Environment variables" %}
Create the following environment variables:
```sh
export KONG_KEYRING_ENABLED=on
export KONG_KEYRING_STRATEGY=cluster
export KONG_KEYRING_RECOVERY_PUBLIC_KEY=/path/to/generated/cert.pem
```
{% endnavtab %}
{% endnavtabs %}

### 3. Start Kong and validate
Once the configuration is updated, you can start your {{site.base_gateway}} instance and use the following request to make sure the Keyring is enabled:

```sh
curl -s localhost:8001/keyring
```

If you haven't added any keys, you'll get the following response:

```json
{
	"ids": {}
}
```

