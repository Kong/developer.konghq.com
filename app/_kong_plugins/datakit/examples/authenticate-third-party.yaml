description: |
  Use internal auth within your ecosystem by sending response headers to upstreams.

title: Authenticate {{site.base_gateway}} to a third-party service
weight: 900

config:
  nodes:
  # set some static values that will be used as inputs to other nodes
  - name: STATIC_INPUTS
    type: static
    values:
      headers:
        Content-Type: application/x-www-form-urlencoded
      body: grant_type=client_credentials

  # merge the statically defined headers with the request headers received from
  # the client
  - name: MERGE_HEADERS
    type: jq
    inputs:
      static: STATIC_INPUTS.headers
      request: request.headers
    jq: ".request * .static"

  # make a POST request to the auth service
  - name: AUTH_REQUEST
    type: call
    inputs:
      headers: MERGE_HEADERS
      body: STATIC_INPUTS.body
    url: "https://my-token-service/auth-token"
    method: POST

  # compose an Authorization header from the access token received from the
  # auth service and add it to the service request headers before proxying
  - name: UPSTREAM_AUTH_HEADER
    type: jq
    input: AUTH_REQUEST.body
    output: service_request.headers
    jq: |
      {
        Authorization: (.token_type + " " + .access_token)
      }

tools:
  - deck
  - admin-api
  - konnect-api
  - kic
  - terraform

min_version:
  gateway: '3.11'
