---
title: 'HMAC Auth'
name: 'HMAC Auth'

content_type: plugin

publisher: kong-inc
description: 'Add HMAC Authentication to your services'


products:
    - gateway

works_on:
    - on-prem
    - konnect

topologies:
  on_prem:
    - hybrid
    - db-less
    - traditional
  konnect_deployments:
    - hybrid
    - cloud-gateways
    - serverless
icon: hmac-auth.png

categories:
  - authentication

search_aliases:
  - hmac authentication
  - hmac-auth
---

Add HMAC Signature authentication to a service or a route
to establish the integrity of incoming requests. The plugin validates the
digital signature sent in the `Proxy-Authorization` or `Authorization` header
(in that order). This plugin implementation is based off the
[draft-cavage-http-signatures](https://tools.ietf.org/html/draft-cavage-http-signatures)
draft with a slightly different signature scheme.

{:.important}
> **Important**: Once the plugin is enabled, any user with a valid credential can access the service or route.
To restrict usage to only some of the authenticated users, also add the
[ACL](/plugins/acl/) plugin (not covered here) and create allowed or
denied groups of users.

## Consumer authentication

Consumers are required for HMAC authentication. Once you [create a Consumer](/gateway/entities/consumer/#set-up-a-consumer), you can configure the Consumer's credentials using one of the following methods:
* **With a database:** Send a `POST` request to the `/consumers/{consumer}/hmac-auth` endpoint.
* **Without a database:** Add a username and secret for authentication in your declarative config file in a `hmacauth_credentials` entry.

For both methods, you'll add a username and optionally a secret used for authentication. If you don't add a secret, {{site.base_gateway}} will generate one for you.

## Signature authentication scheme

The client is expected to send an `Authorization` or `Proxy-Authorization` header
with the following:

```
credentials := "hmac" params
params := keyId "," algorithm ", " headers ", " signature
keyId := "username" "=" plain-string
algorithm := "algorithm" "=" DQUOTE (hmac-sha1|hmac-sha256|hmac-sha384|hmac-sha512) DQUOTE
headers := "headers" "=" plain-string
signature := "signature" "=" plain-string
plain-string   = DQUOTE *( %x20-21 / %x23-5B / %x5D-7E ) DQUOTE
```

The following table describes the signature authentication parameters:

| Parameter| Description |
| ---       | --- |
| `username`  | The `username` of the credential |
| `algorithm` | Digital signature algorithm used to create the signature |
| `headers`   | List of HTTP header names, separated by a single space character, used to sign the request |
| `signature` | `Base64` encoded digital signature generated by the client |

### Signature string construction

To generate the string that is signed with a key, the client
must take the values of each HTTP header specified by `headers` in
the order they appear.

1. If the header name is not `request-line` or `@request-target`,
  append the lowercase header name followed with an ASCII colon `:` and an
  ASCII space ` `.

2. If the header name is `request-line`, append the HTTP
  request line (in ASCII format).

3. If the header name is `@request-target`, append the lowercase request method,
 followed by a ASCII space ` ` and the request URI including any query strings;
 otherwise append the header value.

3. If value isn't the last value, then append an ASCII newline `\n`.
  The string **must not** include a trailing ASCII newline.

{:.info}
> **Note:** The `@request-target` pseudo header was added in the 2.5.0 version of the plugin release. It is similar to the `request-line` pseudo header except that the HTTP version was removed from the signature calculation. Otherwise, semantically equivalent requests that uses HTTP/1.x and HTTP/2 will generate different signature value. It is strongly recommended to use `@request-target` instead of `request-line` with releases of this plugin after 2.5.0.

## Clock skew

The HMAC Authentication plugin also implements a clock skew check as described
in the [specification](https://tools.ietf.org/html/draft-cavage-http-signatures-00#section-3.4) to prevent replay attacks. By default,
a minimum lag of 300s in either direction (past/future) is allowed. Any request
with a higher or lower date value will be rejected. The length of the clock
skew can be edited through the plugin's configuration by setting the
[`clock_skew` property](/plugins/hmac-auth/reference/#schema--config-clock-skew).

The server and requesting client should be synchronized with NTP and a valid
date (using GMT format) should be sent with either the `X-Date` or `Date`
header.

## Body validation

You can set [`config.validate_request_body`](/plugins/hmac-auth/reference/#schema--config-validate-request-body) as `true` to validate the request
body. If it's enabled, the plugin will calculate the `SHA-256` HMAC digest of
the request body and match it against the value of the `Digest` header. The
Digest header needs to be in following format:

```
Digest: SHA-256=base64(sha256(<body>))
```

If there is no request body, the `Digest` should be set to the digest of a
body of 0 length.

{:.info}
> **Note:** To create the digest of a request body, the plugin needs to retain it in memory, which may cause pressure on the worker's Lua VM when dealing with large bodies (several MB) or during high request concurrency.

## Enforcing headers

You can use [`config.enforce_headers`](/plugins/hmac-auth/reference/#schema--config-enforce-headers) to enforce any of the headers to be part
of the signature creation. By default, the plugin doesn't enforce which header
needs to be used for the signature creation. The minimum recommended data to
sign is the `@request-target`, `host`, and `date`. A strong signature would
include all of the headers and a `digest` of the body.

## Upstream Headers

{% include_cached /plugins/upstream-headers.md %}

## Use the API with the HMAC Authentication plugin

The following table describes how you can send `GET` requests to the API endpoints to get information about Consumers associated with the HMAC Authentication plugin:

| Use | Endpoint |
|----|-----------|
| Paginate through the `hmac-auth` credentials for all Consumers | ``curl -X GET http://localhost:8001`/hmac-auths` |
| Filter the list by Consumer | `/consumers/{username or id}/hmac-auth` |
| Retrieve a Consumer associated with an HMAC credential | `/hmac-auths/{hmacUsernameOrId}/consumer` |