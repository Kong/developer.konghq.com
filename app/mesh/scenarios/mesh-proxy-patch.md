---
title: "Advanced Envoy Customization: MeshProxyPatch"
content_type: reference
layout: how-to
breadcrumbs:
  - /mesh/
  - /mesh/scenarios/
description: Mastery of the 'Escape Hatch' of {{site.mesh_product_name}}. Learn how to use MeshProxyPatch to apply low-level Envoy configuration patches for advanced use cases.
products:
  - mesh
tldr:
  q: How do I apply custom Envoy configuration to my sidecars?
  a: |
    Use **MeshProxyPatch** as your "Escape Hatch":
    1. **Target specific workloads** using `targetRef`.
    2. **Define JSON patches** for Envoy listeners, clusters, or filters.
    3. **Apply advanced logic** like Lua scripts or custom WASM filters that are not yet exposed as native policies.
next_steps:
  - text: "{{site.mesh_product_name}} vs. Ambient: Beyond Resource Usage"
    url: "/mesh/scenarios/kong-mesh-vs-ambient/"
---
**MeshProxyPatch** is the "Escape Hatch": it allows Kong Air to apply raw Envoy configuration patches to their flight-critical sidecars.

{% danger %}
**With great power comes great responsibility.**
`MeshProxyPatch` can easily crash your sidecars or cause mesh-wide instability. Only use it when a high-level policy does not exist for your use case, and always test changes in a non-production environment.
{% enddanger %}

## 1. How it Works

`MeshProxyPatch` uses a "JSON Patch" style syntax to modify the Envoy configuration generated by the {{site.mesh_product_name}} Control Plane. You can target specific parts of the Envoy config:
*   **LDS**: Listener Discovery Service (Inbound/Outbound ports).
*   **CDS**: Cluster Discovery Service (Service definitions).
*   **RDS**: Route Discovery Service (HTTP routing logic).

## 2. Example: Custom Lua Filter

Suppose you need to inject a specific HTTP header into every outbound request using a custom Lua script.

{% navtabs "proxy-patch-lua" %}
{% navtab "Kubernetes" %}
```bash
echo 'apiVersion: kuma.io/v1alpha1
kind: MeshProxyPatch
metadata:
  name: outbound-flight-id-injection
  namespace: kong-air-production
spec:
  targetRef:
    kind: Mesh
  default:
    appendModifications:
      - networkFilter:
          operation: AddBefore
          match:
            name: envoy.filters.network.http_connection_manager
            origin: Outbound
          value: |
            name: envoy.filters.http.lua
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
              inline_code: |
                function envoy_on_request(request_handle)
                  request_handle:headers():add("x-custom-header", "kong-mesh-power-user")
                end' | kubectl apply -f -
```
{% endnavtab %}
{% navtab "Universal" %}
```bash
echo 'type: MeshProxyPatch
name: outbound-flight-id-injection
mesh: default
spec:
  targetRef:
    kind: Mesh
  default:
    appendModifications:
      - networkFilter:
          operation: AddBefore
          match:
            name: envoy.filters.network.http_connection_manager
            origin: Outbound
          value: |
            name: envoy.filters.http.lua
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
              inline_code: |
                function envoy_on_request(request_handle)
                  request_handle:headers():add("x-custom-header", "kong-mesh-power-user")
                end' | kumactl apply -f -
```
{% endnavtab %}
{% endnavtabs %}

## 3. Best Practices & Safety

### Avoid Conflicts
If a high-level policy (like `MeshHTTPRoute`) and a `MeshProxyPatch` both try to modify the same field, the resulting behavior can be unpredictable. **Always prefer high-level policies.**

### Target Specifically
Avoid applying patches to the entire `Mesh` unless absolutely necessary. Use `MeshService` or `MeshSubset` to limit the "Blast Radius" of a potential configuration error.

{% navtabs "proxy-patch-targeted" %}
{% navtab "Kubernetes" %}
```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshProxyPatch
metadata:
  name: legacy-app-patch
  namespace: kong-air-production
spec:
  targetRef:
    kind: MeshService
    name: risky-legacy-app # Only patch the proxies that need it
  default:
    appendModifications: []
```
{% endnavtab %}
{% navtab "Universal" %}
```yaml
type: MeshProxyPatch
name: legacy-app-patch
mesh: default
spec:
  targetRef:
    kind: MeshService
    name: risky-legacy-app
  default:
    appendModifications: []
```
{% endnavtab %}
{% endnavtabs %}

### Verification
Always verify your patches by inspecting the Envoy config via the Control Plane's GUI or API:
```bash
# Using the {{site.mesh_product_name}} CLI
kumactl inspect sidecar <pod-name> --type=config-dump
```
